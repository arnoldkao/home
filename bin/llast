#!/bin/bash

scriptName=$(basename $0)

function printUsage()
{
    cat <<EOF
DESCRIPTION: View the last compiler output generated by ~/bin/compileandmore

USAGE: $scriptName [options]

OPTIONS:
    -h | --help     Print this help.
    -l | --list     List all available outputs for the current machine.
    -p | --print    Print the file path and exit.
    -s | --stdout   View the stdout file instead of the err file.
    -N              Operate on the 'N'th last file instead.
                    Example: \`$scriptName -2\`    # Shows second-to-last file.
EOF
}

printOnly=
list=
extension=.err
nthEntry=0
while [ $# -gt 0 ]; do
    case $1 in
        -h | --help)
            printUsage
            exit 0
            ;;
        -l | --list)
            list=true
            ;;
        -p | --print)
            printOnly=true
            ;;
        -s | --stdout)
            extension=.stdout
            ;;
        -*)
            nthEntry=$((0+$(sed 's/^-//' <<<$1)))
            ;;
        *)
            printUsage
            exit 1
            ;;
    esac

    shift
done

compileDir=`grep compileDir= ~/bin/compileandmore | cut -f 2 -d '='`
compileDir=${compileDir/#\~/$HOME}

if [ $nthEntry -ne 0 ]; then
    file=$(ls -1t $compileDir/*$(hostname)*${extension} | head -${nthEntry} | tail -1)
    files=$file
else
    file=$(ls -1t $compileDir/*$(hostname)*${extension} | head -1)
    files=$compileDir/*$(hostname)*${extension}
fi

if [ -n "$list" ]; then
    ls -ltrgo $files | cut -d ' ' -f 3-
    exit
fi

if [ -n "$printOnly" ]; then
    echo $file
else
    less $file
fi
